
<script>
Ext.onReady(function(){
    zongheSortLast = 0;
    zongheSortNext = 0;
    hushuoSortLast = 0;
    hushuoSortNext = 0;
    var msgTip = new Ext.LoadMask(Ext.getBody(),{
        msg:'Excel正在生成中',
        removeMask : true
    });
    Ext.chart.Chart.CHART_URL='/ams/public/js/charts.swf';
    _pageSize = 5;
    /*三个动态框*/
    var teamCombox = new SettCombbox({
        url:'/ams/Info/TeamList?ID=1&Type=1&All=1',
        fieldLabel: '管理班组',
        anchor:'95%',
        id:'team',
        hiddenName:'Team',
        autoLoad:true
    });

    var infoSearch = new Ext.FormPanel({
        title: '查询条件',
        defaults:{
            border: false
        },
        labelAlign: 'right',
        style: 'padding-top:10px',
        url:'/ams/Charges/SearchFee',
        layout:'column',
        items: [{
            columnWidth:.25,
            layout: 'form',
            defaults:{
                xtype: 'textfield'
            },
            items: [
                teamCombox]
        },{
            columnWidth:.25,
            layout: 'form',
            defaults:{
                xtype: 'textfield'
            },
            items: [
                {
                    xtype: 'compositefield',
                    fieldLabel: '电费年月',
                    defaults:{
                        xtype: 'datefield'
                    },
                    items:[
                        new Ext.form.DateField({
                            plugins:'monthPickerPlugin',
                            name:'FromData',
                            value:new Date().format('Ym')-4,
                            width:82,
                            format: 'Ym'
                        }),{
                            xtype: 'displayfield',
                            value: '至: '
                        },new Ext.form.DateField({
                            plugins:'monthPickerPlugin',
                            name:'ToData',
                            width:82,
                            value:new Date().format('Ym'),
                            format: 'Ym'
                        })]
                }
            ]
        },{
            columnWidth:.25,
            layout: 'form',
            items:[{
                width:100,
                xtype:'button',
                text:'查询',
                handler:function(){
                    var data = infoSearch.getForm().getValues();
                    averagePanel.getStore().load({
                        params: data
                    });
                    hushuoPanel.getStore().load({
                        params:data
                    });
                    store.load({
                        params:data
                    })
                }
            }]
        }]
    });
    var searchPanel = new Ext.TabPanel({
        labelWidth: 85,
        activeTab: 0,
        height:70,
        plain:true,
        defaults:{autoScroll: true},
        items:[
            infoSearch
        ]
    });

    var PersonRecord = Ext.data.Record.create([
        {name: 'YearMonth'},
        {name: 'Action'},
        {name: 'Name' },
        {name: 'Value',type:'float'},
        {name: 'sort',type:'int'}
    ]);

    var myStore = new Ext.data.Store({
        url: '/ams/reportsearch/electricity',
        reader: new Ext.data.JsonReader({
            root: 'rows',
            idProperty: 'id'
        }, PersonRecord)
    });

    var myStore2 = new Ext.data.Store({
        url: '/ams/reportsearch/electricity',
        reader: new Ext.data.JsonReader({
            root: 'h_rows',
            idProperty: 'id'
        }, PersonRecord)
    });

    var averagePanel = new Ext.grid.PivotGrid({
        store     : myStore,
        aggregator: 'sum',
        height    : 200,
        title     : '综合排名',
        measure   : 'Value',
        sortAscText : 'sort',
        viewConfig: {
            autoFill:true,
            title: '抄表员<br/>欠费年月'
        },
        tbar:[{
            text:'上一页',
            disabled:true,
            id: 'last',
            handler:function(){
                var data = infoSearch.getForm().getValues();
                data.start = zongheSortLast;
                var arr =[];
                averagePanel.getStore().load({
                    params: data,
                    callback:function(v) {
                        arr = spliceArr(v);
                        zongheSortLast = arr[0] - 6;
                        zongheSortnext =  arr[arr.length - 1];
                    }
                });
            }
        },'->',{
           text:'下一页',
            disabled:true,
            handler:function(){
                var data = infoSearch.getForm().getValues();
                data.start = zongheSortnext;
                var arr =[];
                averagePanel.getStore().load({
                    params: data,
                    callback:function(v, action) {
                        arr = spliceArr(v);
                        zongheSortLast = arr[0] - 6;
                        zongheSortnext =  arr[arr.length - 1];

                    }
                });
            },
            id: 'next'
        }],
        leftAxis: [{
            dataIndex: 'YearMonth'
        }],

        topAxis: [{
            dataIndex: 'sort'
        },{

            dataIndex: 'Name'
        },{
            dataIndex: 'Action'
        }],
        bbar:[{
            text: 'excel',
            iconCls: 'excel',
            handler: function(btn, pressed){
                if (averagePanel.getStore().data.length == 0) {
                    Ext.MessageBox.alert('提示','请先查询数据');
                    return;
                }
                msgTip.show();
                infoSearch.getForm().submit({
                    url:'/ams/export/ReportCharge',
                    success:function(v,action){
                        var re = Ext.decode(action.response.responseText);
                        msgTip.hide();
                        Ext.MessageBox.alert('提示',"<a target='_blank' href='"+re.msg+"'>下载</a>");
                    },
                    failure:function(v,action) {
                        msgTip.hide();
                        Ext.MessageBox.alert('提示','创建失败');
                    }
                })
            }
        }]
    });

    averagePanel.getStore().on('load',function(v){
        var total = v.totalLength;
        if (total !=0) {
            var array = spliceArr(v.data.items);
            zongheSortLast = array[0] - array.length;
            zongheSortnext =  array[array.length - 1];
            Ext.getCmp('last').setDisabled(array[0] == 1);
            Ext.getCmp('next').setDisabled(array[array.length - 1] == total);
        }
    })


    var hushuoPanel = new Ext.grid.PivotGrid({
        store     : myStore2,
        aggregator: 'sum',
        height    : 200,
        //autoHeight:true,
        title     : '户数回收率排名',
        measure   : 'Value',
        viewConfig: {
            autoFill:true,
            title: '抄表员<br/>欠费年月'
        },
        tbar:[{
            text:'上一页',
            disabled:true,
            id: 'lastOne',
            handler:function(){
                var data = infoSearch.getForm().getValues();
                data.start = hushuoSortLast;
                var arr = [];
                hushuoPanel.getStore().load({
                    params: data,
                    callback:function(v) {
                        arr = spliceArr(v);
                        hushuoSortLast = arr[0] - 6;
                        hushuoSortnext =  arr[arr.length - 1];
                    }
                });
            }
        },'->',{
            text:'下一页',
            disabled:true,
            id: 'nextOne',
            handler:function(){
                var data = infoSearch.getForm().getValues();
                data.start = hushuoSortnext;
                var arr = [];
                hushuoPanel.getStore().load({
                    params: data,
                    callback:function(v) {
                        arr = spliceArr(v);
                        hushuoSortLast = arr[0] - 6;
                        hushuoSortnext =  arr[arr.length - 1];
                    }
                });
            }
        }],
        leftAxis: [{
            dataIndex: 'YearMonth'
        }],
        topAxis: [{
         dataIndex: 'sort'
         },{

            dataIndex: 'Name'
        },{
            dataIndex: 'Action'
        }],
        bbar:[{
            text: 'excel',
            iconCls: 'excel',
            handler: function(btn, pressed){
                if (hushuoPanel.getStore().data.length == 0) {
                    Ext.MessageBox.alert('提示','请先查询数据');
                    return;
                }
                msgTip.show();
                infoSearch.getForm().submit({
                    url:'/ams/export/ReportCharge',
                    success:function(v,action){
                        var re = Ext.decode(action.response.responseText);
                        msgTip.hide();
                        Ext.MessageBox.alert('提示',"<a target='_blank' href='"+re.msg+"'>下载</a>");
                    },
                    failure:function(v,action) {
                        msgTip.hide();
                        Ext.MessageBox.alert('提示','创建失败');
                    }
                })
            }
        }]
    });

    hushuoPanel.getStore().on('load',function(v){
        var total = v.totalLength;
        if (total !=0) {
            var array = spliceArr(v.data.items);

            hushuoSortnext =  array[array.length - 1];
            console.log(array);
            Ext.getCmp('lastOne').setDisabled(array[0] == 1);
            Ext.getCmp('nextOne').setDisabled(array[array.length - 1] == total);
        }
    })

    var store = new Ext.data.JsonStore({
        fields:['name', 'visits', 'views'],
        url: '/ams/ReportSearch/user',
        root: 'data'
//        data: [
//            {name:'Jul 07',  views: 3000000},
//            {name:'Aug 07',  views: 3500000},
//            {name:'Sep 07',  views: 4000000},
//            {name:'Oct 07',  views: 4200000},
//            {name:'Nov 07',  views: 4500000},
//            {name:'Dec 07', views: 5800000},
//            {name:'Jan 08',  views: 6000000},
//            {name:'Feb 08',  views: 7500000}
//        ]
    });

    var line = new Ext.Panel({
        iconCls:'chart',
        title: '欠费金额',
        frame:true,
        width:500,
        height:300,
        layout:'fit',
        items: {
            xtype: 'columnchart',
            store: store,
            url:Ext.chart.Chart.CHART_URL,
            xField: 'name',
            tipRenderer : function(chart, record, index, series){
                    return "欠费金额为" + Ext.util.Format.number(record.data.views, '0,0');
            },
            chartStyle: {
                padding: 10,
                animationEnabled: true,
                font: {
                    name: 'Tahoma',
                    color: 0x444444,
                    size: 11
                },
                dataTip: {
                    padding: 5,
                    border: {
                        color: 0x99bbe8,
                        size:1
                    },
                    background: {
                        color: 0xDAE7F6,
                        alpha: .9
                    },
                    font: {
                        name: 'Tahoma',
                        color: 0x15428B,
                        size: 10,
                        bold: true
                    }
                },
                xAxis: {
                    color: 0x69aBc8,
                    majorTicks: {color: 0x69aBc8, length: 4},
                    minorTicks: {color: 0x69aBc8, length: 2},
                    majorGridLines: {size: 1, color: 0xeeeeee}
                },
                yAxis: {
                    color: 0x69aBc8,
                    majorTicks: {color: 0x69aBc8, length: 4},
                    minorTicks: {color: 0x69aBc8, length: 2},
                    majorGridLines: {size: 1, color: 0xdfe8f6}
                }
            },
            series: [{
                type: 'column',
                displayName: 'Page Views',
                yField: 'views',
                style: {
                    image:'bar.gif',
                    mode: 'stretch',
                    color:0x99BBE8
                }
            }]
        }
    });

    var averageTab = new Ext.TabPanel({
        activeTab: 0,
        plain:true,
        autoWidth:true,
        height:400,
        style: 'margin-top:15px',
        items:[
            averagePanel,hushuoPanel
        ],
        listeners:{
            tabchange:function(tp,p){
                averagePanel.store.reload();
                hushuoPanel.store.reload();
            }
        }
    });
    var lineTab = new Ext.TabPanel({
        activeTab: 0,
        plain:true,
        autoWidth:true,
        style: 'margin-top:15px',
        items:[
            line
        ]
    })

    var allPanel = new Ext.Panel({
        region: 'center',
        fileUpload: true,
        autoScroll: true,
        bodyStyle: "padding:20px;",
        items: [
            searchPanel,
            averageTab,
            lineTab
        ]
    });
    new Ext.Viewport(
            {
                layout: 'border',
                items: [
                    allPanel
                ]
            });
});
</script>
<style>
    .x-grid3-row td, .x-grid3-summary-row td {
        font: normal 11px/13px arial, tahoma, helvetica, sans-serif;
    }
</style>