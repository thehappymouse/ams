<script type="text/javascript">
$(document).ready(function(){
	var G = new AjaxFun();

	var clickpage = new ClickPage(G,SetTable);//分页

	var excel = new ExportExcel();
	excel.url = "/ams/export/CountCut";
	excel.exportTo();

	var DrownBox = new DropDownBox()//获取三级下拉框
	DrownBox.select = {"Team":"#team", "Name":"#name"};

	var data = {ID:"1",Type:"1"};
	var url = "/ams/Info/TeamList";
	G.GetAjax('get',url,data,DrownBox.SetAllSelect,true);

	$("#team").on("change","select:eq(0)",function(v){
		var id = $("select:eq(0)").val();
		var data = {ID:id,Type:"Name"};
		var url = "/ams/Info/UserList";
		G.GetAjax('get',url,data,DrownBox.SetAllSelect,true);

	})

	var SearchUrl = "/ams/CountSearch/cut";
	$("button:eq(0)").click(function(){
		data = $("form:eq(0)").serialize();
		excel.Todata = data;
		clickpage.Data = data;
		var SearchData = data+"&Page=1&PageSize="+PageSize; 
		G.GetAjax('get', SearchUrl, SearchData, SetTable,true);
	})

	clickpage.SearchUrl = SearchUrl;
	Page = clickpage.ReturnPage();
	clickpage.PageClick();

	$("body").keydown(function() {
		var msg;
				if (event.keyCode == "13") {
					
					if ($("[name=Num]").focus()) {
						Page = $("[name=Num]").val();

						if (Page>PageNumber || Page<1) {
							msg = "总共只有"+PageNumber+"页。没有第"+Page+"页！";
							popupDiv('pop-div',msg);
							Page =1;
						
						}

						var SearchData = data+"&Page="+Page+"&PageSize="+PageSize;
						clickpage.Page = Page;
					
						G.GetAjax('post',SearchUrl,SearchData,SetTable);
					}
					
				}
  	})

	//添加表格
	function SetTable(value) 
	{
		if (value == null){

			$("#Arrears div").remove();
			$("#tip").css("display","block");
			return ; 

		}
		
		var v =  ReplaceArray(value.data,true);
		var data2 = ReplaceArray(value.data2,true);
		var title = '汇总信息';
		var array = Array("抄表段编号", "用户编号", "用户名称", "用电地址", "电费年月", "电费金额", "停电时间", "停电方式");
		var modelcss = Array("text-align:center;width:80px", "text-align:center;width:60px", "text-align:center;width:70px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis",  "text-align:left;width:160px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis", "text-align:center;width:70px", "text-align:center;width:70px", "text-align:left;width:85px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis", "text-align:center;width:90px");
		var model = Array("Segment", "CustomerNumber", "Name", "Address", "YearMonth", "Money", "CutTime", "CutStyle");
		var Total = value.TotalData.Count;
		
		SetArrearsTable('Arrears',v, data2, array,title,model,false,modelcss,Total);

	}

	//欠费信息表格
	//代表 select是选择器，s数据是填充表格的数据，headarray是表头,title是表格上的标题
	function SetArrearsTable(select,s,data2,headarray,title,model,th,modelcss,total)
	{	
		PageNumber = Math.ceil(total/PageSize);
		Page = clickpage.ReturnPage();
		var s =  ReplaceArray(s);
		var bodyTpl = "";
		var headmodel = "";
		var tr = "";
		var content = "";
		var text;
		var d = 1;
		if (s) {
			for (var i in s) {
				var number = s[i].CustomerNumber
				bodyTpl += '<tr style="height:20px">'+
					'<td  style="text-align:center">'+d+'</td>';
					for (var n in model) {
						if (model[n] == "CutCount" || model[n] == "PressCount" || model[n] == "CustomerNumber") {
							bodyTpl +='<td id="'+model[n]+'" title="'+s[i].ID+'/'+number+'/'+s[i].YearMonth+'" style="text-decoration:underline;cursor:pointer;'+modelcss[n]+'">'+s[i][model[n]]+'</td>';
						} else {
							if(model[n] == "Address" ||model[n]=="CutTime") {
								text = '<div title="'+s[i][model[n]]+'" style="'+modelcss[n]+'">'+s[i][model[n]]+'</div>';
							} else {
								text = s[i][model[n]];
							}
							bodyTpl += '<td style="'+modelcss[n]+'">'+text+'</td>';
						}
					}
		        bodyTpl +='</tr>';
		        d++;
			}
		}
		
		if (PageNumber == 1) {
			PTpl="";
		} else {
			if ( Page == 1 ) {
				PTpl = "<span id='next' style='cursor:pointer'>下一页</span>&nbsp;&nbsp;<span id='end' style='cursor:pointer'>末页</span>";
			} else if (Page < PageNumber && Page!= 1 ) {
				PTpl = "<span id='start' style='cursor:pointer'>首页</span>&nbsp;&nbsp;<span id='prev' style='cursor:pointer'>上一页</span>&nbsp;&nbsp;<span id='next' style='cursor:pointer'>下一页</span>&nbsp;&nbsp;<span id='end' style='cursor:pointer'>末页</span>";
			} else if (Page == PageNumber) {
				PTpl = "<span id='start' style='cursor:pointer'>首页</span>&nbsp;&nbsp;<span id='prev' style='cursor:pointer'>上一页</span>";
			} 
		}
		var CurrentNum = s.length; 
		var pageTpl = '<tr >'+
			    '<td id="PageNum" colspan="10" style="text-align:left">&nbsp;&nbsp;&nbsp;&nbsp;当前第<input name="Num" type="text" value="'+Page+'" style="width:12px;padding:0 8px"  />页，总共'+PageNumber+'页&nbsp;&nbsp;'+PTpl+
			    '&nbsp;&nbsp;<span >本页'+CurrentNum+'条数据，总共'+total+'条数据</span></td>';

		var headTpl = '<div><div class="line ClientInfo" >'+title+'</div><table id="info" class="table-bordered">'+
		    		'<thead>'+
			    	'<tr >'+
			    	'<th style="width:40px">序号</th>';

    	for (var i in headarray) {
    		headmodel +='<th style="'+modelcss[n]+';text-align:center">'+headarray[i]+'</th>';
    	}
		
		
		if (!th){
			 tr = pageTpl+'<tr>'+
			        '<td colspan="10" style="text-align:left" ><form name="excelform" id="excelform" method="post" target="put_excel" >&nbsp;&nbsp;&nbsp;&nbsp;导出文件：&nbsp;&nbsp;<span  id="excel" style="cursor:pointer"><img  src="/ams/public/images/Excel.png" style="height:25px;width:25px"/></span>&nbsp;&nbsp;</form></td>'+
			     '</tr>';

			   for (var a in data2) {
		
			   		content += data2[a]['Year']+'年停电:'+data2[a]['Count']+'笔，'+data2[a]['Money']+'元。';
			   }
			  tr += '<td colspan="10" style="text-align:left" >&nbsp;&nbsp;&nbsp;&nbsp;共计：'+content
			  +'</td>'+
				            '</tr>';
		}   
    	
	    var footTpl = tr + '</tr></thead><tbody></tbody></table></div>';

	    var tpl = headTpl+headmodel+bodyTpl+footTpl;

	    var selected = "#"+select;
	    $(selected+" div").remove();

	    $(selected).append(tpl);
	    $("#tip").css("display","none");
		$(selected+" table tr:even").addClass("InfoTr");

		$(selected+" table tr:eq(0)").removeClass("InfoTr");
	}

	$("#time").val(AgoTime);
	$("#Totime").val(CurrentTime);
})


</script>


<link rel="stylesheet" href="/ams/css/jquery-ui.css">
<script src="/ams/js/jquery-ui.js"></script>
<script src="/ams/js/jquery-ui-timepicker-addon.js"></script>
<link rel="stylesheet" type="text/css" href="/ams/css/jquery-ui-timepicker-addon.css">
<script src="/ams/js/jquery-ui-date.js"></script>
<div>
	<br />
	<div   class="line ClientInfo" >查询条件</div>
	<div style="border:1px solid #009966;height:130px;*height:135px">
		<div style="margin-left:12px;margin-top:15px">
			<form>
			<div>
					<span >管<div class="full"></div>理<div class="full"></div>班<div class="full"></div>组：</span>
					<span id="team">
						
					</span>
					&nbsp;&nbsp;&nbsp;
					<span id="name">
					<span >抄表员：</span>
						
					</span>
				
			</div>
			<div style="margin-top:15px;*margin-left:-2px">
					<span >收费时间至：</span>
					<input  name="FromData"style="width:120px;" type="text" id="time" />
					&nbsp;&nbsp;<div style="display:inline;margin-left:16px;margin-left:10px\0;*margin-left:7px"></div><span >至</span>&nbsp;&nbsp;
					<input  name="ToData"  style="width:120px;margin-left:-1px;margin-left:5px\0;*margin-left:8px" type="text" id="Totime" />
					
					
			</div>
			</form>
			<button  type="button" class="btn btn-success LeftButton" style="background-color:#009966;margin-top:-10px">查询</button>
		</div>
	</div>

</div>
<div id="tip" style="color:red;margin-left:12px;display:none;margin-top:4px">
				当前查询没有数据
</div>
<br />
<div id="Arrears" class="TableCss">
	<div></div>
</div>
<br/><br/><br/><br/>