<script>
Ext.onReady(function(){
    /*三个动态框*/
    var teamCombox = new SettCombbox({
        url:'/ams/Info/TeamList',
        fieldLabel: '管理班组',
        anchor:'95%',
        id:'team',
        hiddenName:'Team',
        autoLoad:true
    });

    var infoSearch = new Ext.FormPanel({
        title: '查询条件',
        defaults:{
            border: false
        },
        labelAlign: 'right',
        style: 'padding-top:10px',
        url:'/ams/Charges/SearchFee',
        layout:'column',
        items: [{
            columnWidth:.25,
            layout: 'form',
            defaults:{
                xtype: 'textfield'
            },
            items: [
                teamCombox]
        },{
            columnWidth:.25,
            layout: 'form',
            defaults:{
                xtype: 'textfield'
            },
            items: [
                {
                    xtype: 'compositefield',
                    fieldLabel: '电费年月',
                    defaults:{
                        xtype: 'datefield'
                    },
                    items:[
                        new Ext.form.DateField({
                            renderTo: document.body,
                            plugins:'monthPickerPlugin',
                            name:'FromData',
                            value:new Date().format('Ym')-4,
                            width:82,
                            format: 'Ym'
                        }),{
                            xtype: 'displayfield',
                            value: '至: '
                        },new Ext.form.DateField({
                            renderTo: document.body,
                            plugins:'monthPickerPlugin',
                            name:'ToData',
                            width:82,
                            value:new Date().format('Ym'),
                            format: 'Ym'
                        })]
                }
            ]
        },{
            columnWidth:.25,
            layout: 'form',
            items:[{
                width:100,
                xtype:'button',
                text:'查询',
                handler:function(){
                }
            }]
        }]
    });
    var searchPanel = new Ext.TabPanel({
        labelWidth: 85,
        activeTab: 0,
        height:70,
        plain:true,
        defaults:{autoScroll: true},
        items:[
            infoSearch
        ]
    });

    var PersonRecord = Ext.data.Record.create([
        {name: 'YearMonth', type: 'string'},
        {name: 'Action', type: 'string'},
        {name: 'Name', type: 'string'},
        {name: 'Value'}
    ]);

    var myStore = new Ext.data.Store({
        url: '/ams/a.json',
        autoLoad: true,
        reader: new Ext.data.JsonReader({
            root: 'rows',
            idProperty: 'id'
        }, PersonRecord)
    });

    var averagePanel = new Ext.grid.PivotGrid({
        store     : myStore,
        aggregator: 'sum',
        width     : 600,
        height:200,
        title     : '综合排名',
        measure   : 'Value',
        leftAxis: [{
            dataIndex: 'YearMonth'
        }],
        topAxis: [{
            dataIndex: 'Name'
        },{
            dataIndex: 'Action'
        }]
    });

    averagePanel.getStore().on('load',function(v){
        var arr = [];
        Ext.each(v.data.items, function(item){
            arr.push(item.data.YearMonth);
        })

        if (arr.length == 0) {
            return;
        }
        var tempArray = arr.slice(0);
        for (var i = 0; i< tempArray.length; i++) {
            for (var j = i + 1; j< tempArray.length; ) {
                if (tempArray[i] == tempArray[j]) {
                    tempArray.splice(j,1);
                } else {
                    j++;
                }
            }
        }
        var n = tempArray.length;
        var Tabheight = 70+(21*n);
        var panelheight = 43+(21*n);
        if (panelheight > 400) {
            panelheight = 400;
            Tabheight = 400;
        }
        averageTab.setHeight(Tabheight);
        averagePanel.setHeight(panelheight);
    })



    var averageTab = new Ext.TabPanel({
        //labelWidth: 85,
        activeTab: 0,
        //autoHeight:true,
        plain:true,
        style: 'margin-top:15px',
        //defaults:{autoScroll: true},
        items:[
            averagePanel
        ]
    });
    var allPanel = new Ext.Panel({
        region: 'center',
        fileUpload: true,
        autoScroll: true,
        bodyStyle: "padding:20px;",
        items: [
            searchPanel,
            averageTab
        ]
    });
    new Ext.Viewport(
            {
                layout: 'border',
                items: [
                    allPanel
                ]
            });
})
 </script>
